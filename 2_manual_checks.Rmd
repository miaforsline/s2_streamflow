---
title: 'Marcell Experimental Forest: S2 Streamflow Manual Checks'
author: "Mia Forsline"
date: '`r format(Sys.time(), "%B %d, %Y")`'
knit: (function(inputFile, encoding) { 
      rmarkdown::render(inputFile,
                        encoding=encoding, output_file="/Users/miaforsline/Desktop/manual_checks/index.html") })
output:
  html_document:
    theme: flatly
    code_folding: hide
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 72
---

# Set Up

Install/load necessary R packages

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE)

#install packages if necessary, then load libraries
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

librarian::shelf(
  here, #for file paths 
  janitor, 
  plotly, #for creating interactive plots 
  readxl, 
  tidyverse,
  zoo #for interpolating missing data points 
  )
```

Read in water year data from CSV files created in `1_water_years.Rmd`
and stored in the `intermediate_data` directory

```{r csv}
wy2017_clean <- read_csv(here("intermediate_data", "wy2017_clean.csv"))
wy2018_altered <- read_csv(here("intermediate_data", "wy2018_altered.csv"))
wy2019_clean <- read_csv(here("intermediate_data", "wy2019_clean.csv")) 
all_streamflow <- read_csv(here("intermediate_data", "all_streamflow.csv"))
```

Set date range

```{r min_max_year}
min_year = 2017
max_year = 2021
```

Create sub-directories if necessary

```{r directories}
output_dir <- file.path(here("intermediate_data"))

if (!dir.exists(output_dir)){
dir.create(output_dir)
} else {
    print("intermediate_data directory already exists!")
}

output_dir <- file.path(here("figures"))

if (!dir.exists(output_dir)){
dir.create(output_dir)
} else {
    print("figures directory already exists!")
}
```

# Manual Streamflow Checks (2017 - 2021)

-   Read in the manual streamflow checkpoints from the External-MEF_DATA
    Box folder
    -   The raw data is found at the following file path:
        `External-MEF_DATA/Hydro/Streamflow/L0_subdaily/ManualChecks`
-   Clean and manipulate the data into a tidy format
    -   Renaming columns to use lower_snake_case and avoid special
        characters via `clean_names()`
    -   Convert the `collected` column from a character into a POSIXct
        date format
    -   Remove rows with NA values in the `stripchart_stage` column
-   Subset the data to include only the data of interest (S2 weir data)
    and the time period of interest (2017 - 2019)
-   Plot the manual checks data

```{r manual_checks}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/ManualChecks"

#temporary filepath after the Hydro folder got moved 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/FoliarChemistry/Hydro/Streamflow/L0_subdaily/ManualChecks"

#read in the manual checks data 
mc <- read_csv(here(filepath, "2017-2021_S2Stage.csv"))

#clean the data
mc_clean <- mc %>% 
  clean_names() %>% 
  #remove S2 lagging pool data and keep only the S2 weir data
  subset(name == "S2 WEIR") %>%
  mutate(collected = as.POSIXct(collected, format = '%m/%d/%Y %H:%M', 
                                tz = "GMT"),
         year = format(as.POSIXct(collected, format = '%Y-%m-%d %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y'),
         date = format(as.POSIXct(collected, format = '%Y-%m-%d %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         diff = point_gage - stripchart_stage
         ) %>% 
  subset(year >= min_year & year <= max_year) 

#point check data 
pc_clean <- mc_clean %>% 
  subset(!is.na(point_gage))

#stripchart check data 
sc_clean <- mc_clean %>% 
  subset(!is.na(stripchart_stage))

#format data for plotting 
mc_plot <- mc_clean %>% 
  select(-logger_stage,
         -year,
         -date,
         -site,
         -name) %>% 
  pivot_longer(cols = c("point_gage", "stripchart_stage"),
               names_to = "type", 
               values_to = "stream_height_ft")

#save clean data CSV to use in future RMD files
write.csv(x = mc_clean, 
          file = file.path(here("intermediate_data", "mc_clean.csv")),
          row.names = FALSE)

write.csv(x = pc_clean, 
          file = file.path(here("intermediate_data", "pc.csv")),
          row.names = FALSE)

write.csv(x = sc_clean, 
          file = file.path(here("intermediate_data", "sc_clean.csv")),
          row.names = FALSE)

write.csv(x = mc_plot, 
          file = file.path(here("intermediate_data", "mc_plot.csv")),
          row.names = FALSE)

#plot 
ggplot(data = mc_plot) + 
  geom_point(aes(x = collected, 
                 y = stream_height_ft,
                 color = type),
             alpha = 0.5) +  
  theme_classic() + 
  labs(y = "Stream Height (ft)", 
       x = "Time", 
       title = paste0("S2 Weir Manual Streamflow Checks (", min_year, "-", max_year, ")"),
       color = "Checkpoint Type"
       ) + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  scale_color_discrete(labels = c("Point Gage", "Stripchart Stage"))
```

# Streamflow + Manual Checks (2017 - 2021)

-   Combine all 3 water years using `rbind()`

-   Plot stripchart data (as lines) then add the manual checks (as
    points) on top

For interactive plots,

-   stripchart stream height (ft) is plotted as a black line, and

-   manual checkpoints of stream height (ft) are plotted as [red
    dots]{style="color:red"}.

```{r wy2017-2021}
#plot
p_all <- ggplot() +
  #stripchart streamflow data
  geom_line(data = all_streamflow,
            aes(x = datetime, 
                y = stream_height_ft,
                group = 1,
                #create hovering labels for interactive graph 
                text = paste0("DateTime: ", datetime, "\n",
                              "Stream Height (ft): ", round(stream_height_ft, digits = 3))),
            size = 0.25) + 
  #manual checkpoints 
  geom_point(data = mc_clean, 
             aes(x = collected, 
                 y = point_gage,
                 group = 1,
                 #create hovering labels for interactive graph 
                 text = paste0("DateTime: ", collected, "\n",
                              "Stream Height Checkpoint (ft): ", round(stripchart_stage, digits = 3))), 
             color = "red",
             size = 0.5) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)",
       title = paste0("S2 Bog Stream Height (", min_year, "-", max_year, ")"
       ),
       subtitle = "Stripchart data are plotted as black lines. Manual checks are plotted as red dots.") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

#static plot
#p_all

# #save PNG file
# ggsave(filename = "streamflow_with_manual_checks.png",
#        plot = p_all,
#        path = "figures/",
#        width = 6,
#        height = 3,
#        units = c("in"),
#        dpi = 300)

#interactive plot 
ggplotly(p_all, tooltip = "text")
```

## 1:1 Stripchart vs Manual Checkpoints Comparison (2017 - 2021)

Next, we are interested in a 1:1 comparison of stripchart data vs manual
checkpoints data at the exact same timestamp. Since the stripchart data
and manual checkpoints do not align perfectly, we will interpolate the
stripchart stream flow values using the `na.approx()` function from the
`zoo` package to estimate stripchart values at the time of the manual
checks.

## Stripchart vs Stripchart Stage 

-   Clean the data

-   Note that the manual checks data only range from 2017-04-04 to
    2019-12-31, which is a smaller time range than the stripchart data

```{r interpolate_sc}
#clean the stripchart_stage data 
sc_sub <- mc_clean %>% 
  #extract the data (without the timestamp)
  mutate(date = format(as.POSIXct(collected, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT"),
         year = as.numeric(year)
         ) %>% 
  #rename column
  rename(datetime = collected) %>% 
  #remove unnecessary columns 
  select(-site, -lab_id, -name, -point_gage, -logger_stage) 

#identify date ranges of interest: 2017-04-04 to 2019-12-31
##aka the range of the manual checkpoint data
max_date <- max(sc_sub$date)
min_date <- min(sc_sub$date)
nrows <- nrow(sc_sub)

#subset stripchart data to fit within the time range of the manual checkpoints
streamflow_sub <- all_streamflow %>% 
  mutate(
    year = format(as.POSIXct(datetime, format = '%m/%d/%Y %H:%M:%S', 
                             tz = "GMT"),
                  format = '%Y'), 
    year = as.numeric(year)
    ) %>% 
  subset(date <= max_date & date >= min_date) 
```

-   Join the stripchart_stage dataset with the continuous stripchart dataset

-   Plot the data to visually examine if the approximated values
    generated by na.approx() look correct

```{r join_sc}
#join the stripchart data and manual checks data 
fj_sc <- full_join(x = sc_sub, 
                y = streamflow_sub, 
                by = c("datetime", "date", "year"))  %>%
  #interpolate to fill in missing NA values
  mutate(approx = na.approx(object = stream_height_ft,
                            x = datetime,
                            xout = datetime,
                            method = "linear",
                            maxgap = 6),
         #calculate the difference between approximated values and real values
         diff = approx - stream_height_ft) 


# %>% 
#   #rearrange dataframe into a long format
#   pivot_longer(cols = c("stripchart_stage", "stream_height_ft"),
#                names_to = "types",
#                values_to = "stream_height_ft")

##visually examine the approximated values 
# ggplot(data = fj_sc) +
#   geom_line(aes(x = datetime, y = approx))
# 
# ggplot(data = fj_sc) +
#   geom_point(aes(x = datetime,
#                 y = stream_height_ft,
#                 color = types))
# 
# ggplot(data = fj_sc) +
#   geom_point(aes(x = datetime,
#                 y = stream_height_ft,
#                 color = types)) +
#   geom_point(aes(x = datetime,
#                 y = approx),
#              alpha = 0.05)


fj_sc <- fj_sc %>%
  #remove extraneous columns 
  select(-stream_height_ft, -diff) %>% 
  #return to wide format to create scatterplot
  pivot_wider(
    names_from = "types",
    values_from = "approx"
  ) %>% 
  #unlist the columns created by pivot_wider() 
  unnest


# #visually examine all data 
# ggplot(data = fj_sc) +
#   geom_point(aes(x = manual_check,
#                  y = stripchart))
```

-   Subset the joined dataframe to include only the timestamps of
    interest (AKA the timestamps from the original stripchart_stage
    dataset)

-   Plot

```{r 1_to_1_sc}
#left join the joined data and stripchart_stage data to keep only the timestamps of interest 
lj_sc <- left_join(x = sc_sub, 
                y = fj_sc,
                by = c("datetime", "year", "date", "stripchart_stage")) %>% 
  #ensure the correct column types
  mutate(stripchart_stage = as.numeric(stripchart_stage),
         stream_height_ft = as.numeric(stream_height_ft),
         diff = stripchart_stage - stream_height_ft)

#test if the subsetted data has the same number of observations as the manual checks dataframe
if(nrow(lj_sc) != (nrow(sc_sub))) stop("Check lj_sc dataframe dimensions")

#test if the approximated data differs greatly from the stripchart/manual checks data 
if(abs(lj_sc$diff) > 0.01 ) stop("Check differences")

#save clean data CSV to use in future RMD files
write.csv(x = lj_sc, 
          file = file.path(here("intermediate_data", "lj_sc.csv")),
          row.names = FALSE)
```

```{r 1_to_1_plot_sc}
#plot 
p_1to1 <- ggplot() + 
  geom_point(data = lj_sc, 
             aes(x = stripchart_stage, #approximated values from manual checkpoints
                 y = stream_height_ft, #continuous stripchart values 
                 group = 1,
                 #create hovering labels for interactive graph 
                 text = paste0("Stripchart Stage (ft): ", stripchart_stage, "\n",
                              "Stripchart (ft): ", stream_height_ft)),
             alpha = 0.4) + 
  theme_classic() +
  labs(x = "Stripchart Stage",
       y = "Stripchart",
       title = paste0("S2 Stripchart vs Interpolated Stripchart Values (", min_year, "-", max_year, ")"),
       subtitle = "The line y = x is plotted for reference.") +
    theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) + 
  geom_abline(slope = 1, intercept = 0) +
  xlim(0, 0.4) +
  ylim(0, 0.4)

#static plot
#p_1to1

# #save the figure 
# ggsave(filename = "streamflow_mc_comparison.png",
#        plot = p_1to1,
#        path = "figures/",
#        width = 6,
#        height = 5,
#        units = c("in"),
#        dpi = 300)

#interactive plot 
ggplotly(p_1to1, tooltip = "text")
```

## Stripchart vs Point Gage Manual Checkpoints 

```{r pc}
#clean the point gage data 
pc_sub <- pc_clean %>% 
  #extract the data (without the timestamp)
  mutate(date = format(as.POSIXct(collected, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT"),
         year = as.numeric(year)
         ) %>% 
  #rename column
  rename(datetime = collected) %>% 
  #remove unnecessary columns 
  select(-site, 
         -lab_id, 
         -name, 
         -stripchart_stage, 
         -logger_stage,
         -diff)
  

#identify date ranges of interest: 2017-04-04 to 2019-12-31
##aka the range of the manual checkpoint data
max_date <- max(pc_sub$date)
min_date <- min(pc_sub$date)
nrows <- nrow(pc_sub)

# #subset stripchart data to fit within the time range of the manual checkpoints
# streamflow_sub <- all_streamflow %>% 
#   mutate(
#     year = format(as.POSIXct(datetime, format = '%m/%d/%Y %H:%M:%S', 
#                              tz = "GMT"),
#                   format = '%Y'), 
#     year = as.numeric(year)
#     ) %>% 
#   subset(date <= max_date & date >= min_date) 
```

-   Join the manual checks dataset with the stripchart dataset

-   Plot the data to visually examine if the approximated values
    generated by na.approx() look correct

```{r join_pc}
#join the stripchart data and manual checks data 
fj_pc <- full_join(x = pc_sub, 
                y = streamflow_sub, 
                by = c("datetime", "date", "year")) %>% 
  #rename columns 
  rename(manual_check = point_gage,
         stripchart = stream_height_ft) %>% 
  #interpolate to fill in missing NA values
  mutate(approx = na.approx(object = stripchart,
                            x = datetime,
                            method = "linear",
                            maxgap = 6))

# #rearrange dataframe into a long format
#   pivot_longer(cols = c("manual_check", "stripchart"),
#                names_to = "types",
#                values_to = "stream_height_ft") %>%

# #visually examine the approximated values
# ggplot(data = fj_pc) +
#   geom_line(aes(x = datetime, y = approx))
# 
# ggplot(data = fj_pc) +
#   geom_point(aes(x = datetime,
#                 y = stream_height_ft,
#                 color = types))
# 
# ggplot(data = fj_pc) +
#   geom_point(aes(x = datetime,
#                 y = stream_height_ft,
#                 color = types)) +
#   geom_point(aes(x = datetime,
#                 y = approx),
#              alpha = 0.05)


fj_pc <- fj_pc %>%
  #remove extraneous columns 
  select(-stripchart) 
# %>% 
#   #return to wide format to create scatterplot
#   pivot_wider(
#     names_from = "types",
#     values_from = "approx"
#   ) %>% 
#   #unlist the columns created by pivot_wider() 
#   unnest


# #visually examine all data
# ggplot(data = fj_pc) +
#   geom_point(aes(x = manual_check,
#                  y = stripchart))
```

-   Subset the joined dataframe to include only the timestamps of
    interest (AKA the timestamps from the original manual checks
    dataset)

-   Plot

```{r 1_to_1_pc}
#left join the joined data and manual checks data to keep only the timestamps of interest 
lj_pc <- left_join(x = pc_sub, 
                y = fj_pc,
                by = c("datetime", "year", "date", "point_gage" = "manual_check")) %>% 
  #ensure the correct column types
  mutate(point_gage = as.numeric(point_gage),
         approx = as.numeric(approx),
         diff = point_gage - approx)

#test if the subsetted data has the same number of observations as the manual checks dataframe
if(nrow(lj_pc) != (nrow(pc_sub))) stop("Check lj dataframe dimensions")

#test if the approximated data differs greatly from the stripchart/manual checks data 
if(abs(lj_pc$diff) > 0.01 ) stop("Check differences")

#save clean data CSV to use in future RMD files
write.csv(x = lj_pc, 
          file = file.path(here("intermediate_data", "lj_pc.csv")),
          row.names = FALSE)
```

```{r 1_to_1_plot_pc}
#plot 
p_1to1 <- ggplot() + 
  geom_point(data = lj, 
             aes(x = manual_check, 
                 y = stripchart, 
                 group = 1,
                 #create hovering labels for interactive graph 
                 text = paste0("Manual Checkpoint (ft): ", manual_check, "\n",
                              "Stripchart (ft): ", stripchart)),
             alpha = 0.5) + 
  theme_classic() +
  labs(x = "Manual Checkpoints",
       y = "Stripchart Data",
       title = paste0("S2 Manual Checks vs Interpolated Stripchart Values (", min_year, "-", max_year, ")"),
       subtitle = "The line y = x is plotted for reference.") +
    theme(plot.title = element_text(hjust = 0.5),
          plot.subtitle = element_text(hjust = 0.5)) + 
  geom_abline(slope = 1, intercept = 0) +
  xlim(0, 0.4) +
  ylim(0, 0.4)

#static plot
#p_1to1

# #save the figure 
# ggsave(filename = "streamflow_mc_comparison.png",
#        plot = p_1to1,
#        path = "figures/",
#        width = 6,
#        height = 5,
#        units = c("in"),
#        dpi = 300)

#interactive plot 
ggplotly(p_1to1, tooltip = "text")
```


Note that this file is being knit as
[`index.html`](https://github.com/miaforsline/manual_checks/blob/main/index.html)
into the [`manual_checks`
repository](https://github.com/miaforsline/manual_checks) in order to
update the [GitHub pages
website](https://miaforsline.github.io/manual_checks/), where the plots
can be viewed online.
