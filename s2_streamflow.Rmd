---
title: 'Marcell Experimental Forest: S2 Stream Height (Water Years 2017 - 2019)'
author: "Mia Forsline"
date: '`r format(Sys.time(), "%B %d, %Y")`'
output:
  html_document:
    theme: flatly
    code_folding: show
    toc: yes
    toc_float: yes
  pdf_document:
    toc: yes
editor_options:
  markdown:
    wrap: 72
---

# Set Up

-   Install/load necessary R packages
-   Set working directory if necessary (or create a file path to use
    throughout the RMD to call the data from Box)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE, 
                      warning = FALSE)

#install packages if necessary, then load libraries
if (!require(librarian)){
  install.packages("librarian")
  library(librarian)
}

librarian::shelf(
  here,
  janitor,
  plotly,
  readxl,
  tidyverse
  )

# Set working directory path
## Mia's working directory path
#setwd("/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts/AnnualBreakPoint/S2")
## Nina's working directory path 
#setwd("~/../../Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts")
```

# Streamflow data

## Water Year 2017

-   Read in the WY 2017 data from the External-MEF_DATA Box folder
-   Specifically, raw data for the S2 Bog site is found at the following
    file path:
    `External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts/AnnualBreakPoint/S2`
-   Clean and manipulate the WY 2017 data into a tidy format
    -   Rename columns to use lower_snake_case and avoid special
        characters
    -   Create a new `date` column that follows the format YYYY-MM-DD
        (and does not include a timestamp) for ease of
        sorting/manipulating dates
-   Test that the manipulated data frame has the same number of rows as
    the original data frame (we do not want to accidentally lose data,
    so the code will throw an error is the two data frames do not match)
-   Create an interactive plot of the WY 2017 data

```{r wy2017}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts/AnnualBreakPoint/S2"

#read in the 2017 data 
wy2017 <- read_excel(path = here(filepath, "WY2017.S2_Breakpoint.xlsx"), 
                     skip =3)

#clean the 2017 data
wy2017_clean <- wy2017 %>% 
  #change column names
  rename(datetime = "Date/time",
         stream_height_ft = "Stage.ft") %>% 
  #remove unnecessary columns 
  select(c("datetime", "stream_height_ft")) %>% 
  #format column names 
  clean_names() %>% 
  #create a date column 
  mutate(date = format(as.POSIXct(datetime, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT")) 

#test the 2017 data
if(nrow(wy2017) != nrow(wy2017_clean)) stop("Check clean dataframe dimensions")

#plot 
p_2017 <- ggplot(data = wy2017_clean) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)", 
       title = "WY 2017 S2 Bog Stream Height") + 
  theme(plot.title = element_text(hjust = 0.5))

#static plot 
p_2017

#interactive plot 
#ggplotly(p_2017)
```

## Water Year 2018

-   Read in the WY 2018 data from the External-MEF_DATA Box folder
-   Clean and manipulate the WY 2018 data into a tidy format
    -   Rename columns to use lower_snake_case and avoid special
        characters
    -   Create a new `date` column that follows the format YYYY-MM-DD
-   Change values of 0 to missing NA values during the following time
    periods:
    -   December 1-3 clock stopped, no record

    -   December 8-10 pin reached end of chart, no record

    -   Dec 11-end, clock is barely running. No way to tell which days
        are what on the chart.

    -   November 10-14 clock stopped, no record

    -   November 25- December 4 clock stopped, no record Possibly the
        clock was moving super slowly for some of it?

    -   For Oct 9-10 there was no rain for flow to increase

    -   Oct 11-15 clock was stuck and the pin did not move forward in
        time
-   Note that the NA values are derived from notes found at the
    following Box filepath:
    `External-MEF_DATA/Hydro/Streamflow/L0_daily/StripCharts/DailyBreakpoint/`
-   Test that the manipulated data frame has the same number of rows as
    the original data frame
-   Create an interactive graph of the WY 2018 data

```{r wy2018}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts/AnnualBreakPoint/S2"

#create a function to specify custom time intervals 
`%between%` <- function(x, interval) x >= interval[1] & x <= interval[2]

#read in the 2018 data 
wy2018 <- read_excel(path = here(filepath, "WY2018.S2_Breakpoint.xlsx"), 
                     skip =3)

#clean the 2018 data
wy2018_clean <- wy2018 %>% 
  rename(datetime = "Date/time",
         stream_height_ft = "Stage.ft") %>% 
  select(c("datetime", "stream_height_ft")) %>% 
  clean_names() %>% 
  mutate(date = format(as.POSIXct(datetime, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT")) 

#assign October NA values 
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-10-09', '2018-10-10'))] <- NA
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-10-11', '2018-10-15'))] <- NA

#assign November NA values 
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-11-10', '2018-11-14'))] <- NA
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-11-25', '2018-12-04'))] <- NA

#assign December NA values 
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-12-01', '2018-12-03'))] <- NA
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-12-08', '2018-12-10'))] <- NA
wy2018_clean$stream_height_ft[wy2018_clean$date %between% as.Date(c('2018-12-11', '2018-12-31'))] <- NA

#test the 2018 data
if(nrow(wy2018) != nrow(wy2018_clean)) stop("Check clean dataframe dimensions")

#plot
p_2018_clean <- ggplot(data = wy2018_clean) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)", 
       title = "WY 2018 S2 Bog Stream Height") + 
  theme(plot.title = element_text(hjust = 0.5))

#note the weird oscillating values from Oct 31 - Nov 1 
p_2018_clean

#ggplotly(p_2018_clean)

#we need to remove wonky values from Oct 31 - Nov 1, 2018 (for more details see the code chunk below)
wy2018_altered <- wy2018_clean

#for now, remove erroneous values < 0.10 during the time period of interest 
wy2018_altered <- subset(wy2018_altered, !(wy2018_altered$date %between% as.Date(c('2018-10-31', '2018-11-01')) & wy2018_altered$stream_height_ft < 0.10))

#test the 2018 altered data - there should be fewer rows in the altered dataframe than the original/cleaned dataframe 
if(nrow(wy2018_altered) == nrow(wy2018_clean)) stop("Check altered dataframe dimensions")

#plot
p_2018_altered <- ggplot(data = wy2018_altered) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)", 
       title = "WY 2018 S2 Bog Stream Height") + 
  theme(plot.title = element_text(hjust = 0.5))

#note that the wonky values have been removed and smoothed out 
p_2018_altered

#ggplotly(p_2018_altered)
```

### Altered Oct 31 - Nov 1, 2018 date value

During this time, it is most likely that the dates were read/input
incorrectly, resulting in an unnatural oscillation of streamflow values
on Oct 31 and Nov 1 of 2018. Therefore, we removed values \< 0.10 during
this time period to smooth out the overall curve of stream height
values.

```{r wy2018_altered}
#subset the time period of interest
subset_2018 <- wy2018_clean %>% 
  subset(date %between% as.Date(c('2018-10-30', '2018-11-02'))) 

#plot the data 
p_subset <- ggplot(data = subset_2018) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  labs(title = "Wonky Oct 31 - Nov 1 Streamflow Values")

p_subset

#ggplotly(p_subset)

#remove unusual values below 0.10 
subset_2018_altered <- wy2018_clean %>% 
  subset(date %between% as.Date(c('2018-10-30', '2018-11-02'))) %>% 
  subset(stream_height_ft > 0.10)

#plot the altered data
p_subset_altered <- ggplot(data = subset_2018_altered) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  labs(title = "Fixed Oct 31 - Nov 1 Streamflow Values")

p_subset_altered

#ggplotly(p_subset_altered)
```

## Water Year 2019

-   Read in the WY 2019 data from the External-MEF_DATA Box folder
-   Clean and manipulate the WY 2019 data into a tidy format
-   Change values of 0 to missing NA values during the following time
    periods:
    -   April 1-2, Line and time is off

    -   April 8-17. Line doesn't fluctuate though there should've been
        rain or if not rain, it should've fallen from how high the flow
        is

    -   Proven in that the adjustment for 4/15 flow is great and S6 Weir
        chart response. Therefore, no record

    -   April 17-22 discounted because pen level is off with no way to
        account for it

    -   February: Clock errors, record compromised. Flow is below zero
        for month Clock restarted 2/21/2019. Measurements still below
        zero.

    -   January: Clock errors meant that time could not be used to
        record accurate measurements. Measurements tend to be around
        0.001 and chart line is there or below zero. Physical
        measurements indicate flow until at least 1/15/2019

    -   March 14, Pen reverses and goes off the chart

    -   March 18th, Pen placed back on chart, still reversed (fixed
        4/23)

    -   March 30-31 Pen stays in place even though there should be a
        response. Likely because it reached the bottom of the chart (pen
        was reversed)

    -   September: Chart did not run from 9/3-9/10
-   Note that the NA values are derived from notes found at the
    following Box filepath:
    `External-MEF_DATA/Hydro/Streamflow/L0_daily/StripCharts/DailyBreakpoint/`
-   Test the data
-   Create an interactive graph of the WY 2019 data

```{r wy2019}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/StripCharts/AnnualBreakPoint/S2"

#read in the 2019 data 
wy2019 <- read_excel(path = here(filepath, "WY2019.S2_Breakpoint.xlsx"), 
                     skip =3)

#clean the 2019 data
wy2019_clean <- wy2019 %>% 
  rename(datetime = "Date/time",
         stream_height_ft = "Stage.ft") %>% 
  select(c("datetime", "stream_height_ft")) %>% 
  clean_names() %>% 
  mutate(date = format(as.POSIXct(datetime, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT")) 

#February NA values 
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-04-01', '2019-04-02'))] <- NA

#March NA values 
wy2019_clean$stream_height_ft[wy2019_clean$date == as.Date('2019-03-14')] <- NA
wy2019_clean$stream_height_ft[wy2019_clean$date == as.Date('2019-03-18')] <- NA
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-03-30', '2019-03-31'))] <- NA

#April NA values 
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-04-01', '2019-04-02'))] <- NA
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-04-08', '2019-04-17'))] <- NA
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-04-17', '2019-04-22'))] <- NA

#September NA values 
wy2019_clean$stream_height_ft[wy2019_clean$date %between% as.Date(c('2019-09-03', '2019-09-10'))] <- NA

#test the 2019 data 
if(nrow(wy2019) != nrow(wy2019_clean)) stop("Check clean dataframe dimensions")

#plot 
p_2019 <- ggplot(data = wy2019_clean) + 
  geom_line(aes(x = datetime, y = stream_height_ft)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (Ft)",
       title = "WY 2019 S2 Bog Stream Height") + 
  theme(plot.title = element_text(hjust = 0.5))

#static plot
p_2019

#interactive plot
ggplotly(p_2019)
```

## Manual Streamflow Checks (2017 - 2019)

-   Read in the manual checks data from the External-MEF_DATA Box folder
    -   Specifically, raw data is found at the following file path:
        `External-MEF_DATA/Hydro/Streamflow/L0_subdaily/ManualChecks`
-   Clean and manipulate the data into a tidy format
    -   Renaming columns to use lower_snake_case and avoid special
        characters via `clean_names()`
    -   Convert the `collected` column from a character into a POSIXct
        date format
    -   Remove rows with NA values in the `stripchart_stage` column
-   Subset the data to include only the data of interest (S2 weir data)
    and the time period of interest (2017 - 2019)
-   Plot the manual checks data

```{r manual_checks}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L0_subdaily/ManualChecks"

#read in the manual checks data 
mc <- read_csv(here(filepath, "2017-2021_S2Stage.csv"))

#clean the data
mc_clean <- mc %>% 
  clean_names() %>% 
  #remove S2 lagging pool data and keep only the S2 weir data
  subset(name == "S2 WEIR") %>%
  mutate(collected = as.POSIXct(collected, format = '%m/%d/%Y %H:%M', 
                                tz = "GMT"),
         year = format(as.POSIXct(collected, format = '%Y-%m-%d %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y')
         ) %>% 
  subset(year >= 2017 & year <= 2019) %>% 
  subset(!is.na(stripchart_stage))

#plot 
ggplot(data = mc_clean) + 
  geom_point(aes(x = collected, y = stripchart_stage)) + 
  theme_classic() + 
  labs(y = "Stream Height (ft)", 
       x = "Time", 
       title = "S2 Weir Manual Streamflow Checks (2017 - 2019)") + 
  theme(plot.title = element_text(hjust = 0.5))
```

## Streamflow + Manual Checks (2017 - 2019)

-   Combine all 3 water years using `rbind()`

-   Plot stripchart data (as lines) and manual checks (as points)

```{r wy2017-2019}
#combine 2017 - 2019 data
all_streamflow <- rbind(wy2017_clean, wy2018_clean, wy2019_clean)

#plot
p_all <- ggplot(data = all_streamflow) + 
  geom_line(aes(x = datetime, y = stream_height_ft),
            size = 0.25) + 
  geom_point(data = mc_clean, 
             aes(x = collected, 
                 y = stripchart_stage), 
             color = "red",
             size = 0.5) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)",
       title = "WY 2017 - 2019 S2 Bog Stream Height",
       subtitle = "Stripchart data are plotted as black lines. Manual checks are plotted as red dots.") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5))

#static plot
#p_all

#save PNG file
ggsave(filename = "streamflow_with_manual_checks.png",
       plot = p_all,
       path = "figures/",
       width = 6,
       height = 3,
       units = c("in"),
       dpi = 300)

#interactive plot 
ggplotly(p_all)
```

## Stripchart vs manual checks (2017 - 2019)

```{r}
#extract date column
mc_sub <- mc_clean %>% 
  mutate(date = format(as.POSIXct(collected, format = '%m/%d/%Y %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y-%m-%d'),
         date = as.POSIXct(date, tz = "GMT")) %>% 
  rename(datetime = collected) %>% 
  select(-site, -lab_id, -name, -point_gage, -logger_stage)

#identify date ranges: 2017-04-04 to 2019-12-31 
max_date <- max(mc_sub$date)
min_date <- min(mc_sub$date)

#subset streamflow data to fit within the time range of the manual checks 
streamflow_sub <- all_streamflow %>% 
  subset(date <= max_date & date >= min_date)

ggplot() + 
  geom_point(data = streamflow_sub, 
             aes(x = datetime, y = stream_height_ft),
             color = "blue",
             alpha = 0.1) + 
  geom_point(data = mc_sub, 
             aes(x = datetime, y = stripchart_stage),
             color = "red") + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)")
```

## Water Year 2020

## Water Year 2021

# Old Shaft Encoder Data (2017 - 2019)

-   Read in the manual checks data from the External-MEF_DATA Box folder

    -   Specifically, raw data is found at the following file path:
        `External-MEF_DATA/Hydro/Streamflow/L1_subdaily`

-   Clean and manipulate the data into a tidy format

    -   Renaming columns to use lower_snake_case and avoid special
        characters via `clean_names()`
    -   Remove extraneous columns
    -   Rename columns to join the data later

-   Plot the old shaft encoder data

```{r}
#create file path to call the data from Box 
## Mia's file path 
filepath <- "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/Hydro/Streamflow/L1_subdaily/"

#read in the 2019 data 
se_data <- read_csv(here(filepath, "S2_5min_2017-2019.csv"))

#clean the data 
se_clean <- se_data %>% 
  clean_names() %>% 
  select(-x1, -record, -cond, -ct, -streamflow_cfs, -streamflow_lps, -temp_c) %>% 
  rename(datetime = timestamp)

#plot 
ggplot() + 
  geom_line(data = se_clean, aes(x = datetime, y = stage)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)",
       title = "Shaft Encoder S2 Bog (2017 - 2019)") + 
  theme(plot.title = element_text(hjust = 0.5))
  
```

# Climate and Bogwell data

## Precipitation Every 15min

-   Read in the data from the following Box file path:
    `External-MEF_DATA/EDI/precipitation_15min/edi.849.2/data_objects/`

-   Clean the data into a tidy format

    -   Subset precipitation data to 2017 - present

-   Plot

```{r precip_15}
#set file path to read in data from Box 
filepath = "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/EDI/precipitation_15min/edi.849.2/data_objects/"

#read in the raw data 
precip_15 <- read_csv(here(filepath, "MEF_South_precip_15min.csv"))

#clean the data 
precip_15_clean <- precip_15 %>% 
  clean_names() %>% 
  mutate(year = format(as.POSIXct(timestamp, format = '%Y-%m-%d %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y'),
         year = as.numeric(year)) %>% 
  subset(year >= 2017) %>% 
  rename(precip_in = south_pcp) %>% 
  mutate(precip_10 = (precip_in / 10)) %>% 
  pivot_longer(
    cols = c("precip_in", "precip_10"),
    names_to = "precip_type",
    values_to = "precip_in"
  )

#plot 
p_15 <- ggplot(data = precip_15_clean) + 
  geom_line(aes(x = timestamp, y = precip_in, color = precip_type)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Precipitation (cm)", 
       title = "2017 - 2019 Precipitation Sum Every 15 Min")

#ggplotly(p_15)
```

## Precipitation Daily

-   Read in the data from the following Box file path:
    `External-MEF_DATA/EDI/precipitation_daily/edi.563.3/data_objects/`

-   Clean the data into a tidy format

    -   Subset precipitation data to 2017 - present

-   Plot

```{r precip_daily}
#set file path to read in data from Box 
filepath = "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/EDI/precipitation_daily/edi.563.3/data_objects/"

#read in the raw data 
precip_daily <- read_csv(here(filepath, "MEF_precipitation_daily.csv"))

#clean the data 
precip_daily_clean <- precip_daily %>% 
  clean_names() %>% 
  select(date, south_pcp, south_flag) %>% 
  mutate(year = format(as.POSIXct(date, format = '%Y-%m-%d', 
                                  tz = "GMT"), 
                       format = '%Y'),
         year = as.numeric(year)) %>% 
  subset(year >= 2017) %>% 
  rename(precip_in = south_pcp) %>% 
  mutate(precip_10 = (precip_in / 10)) %>% 
  pivot_longer(
    cols = c("precip_in", "precip_10"),
    names_to = "precip_type",
    values_to = "precip_in"
  )

#plot 
p_daily <- ggplot(data = precip_daily_clean) + 
  geom_line(aes(x = date, y = precip_in, color = precip_type)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "South Precipitation (in)", 
       title = "2017 - 2019 Precipitation Daily Sum")

#ggplotly(p_daily)
```

## Air Temperature Every 30 Min

-   Read in the data from the following Box file path:
    `External-MEF_DATA/EDI/airT_RH_BP_30min/edi.990.1/data_objects/`

-   Clean the data into a tidy format

    -   Subset precipitation data to 2017 - present

-   Plot

```{r airtemp_30}
#set file path to read in data from Box 
filepath = "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/EDI/airT_RH_BP_30min/edi.990.1/data_objects/"

#read in the raw data 
air_temp_30 <- read_csv(here(filepath, "MEF_S2Bog_Met_30min.csv"))

#clean the data 
air_temp_30_clean <- air_temp_30 %>% 
  clean_names() %>% 
  rename(airtempc = air_t,
         rel_humidity = rh,
         datetime = timestamp) %>% 
  mutate(year = format(as.POSIXct(datetime, format = '%Y-%m-%d %H:%M:%S', 
                                  tz = "GMT"), 
                       format = '%Y'),
         year = as.numeric(year),
         airtempc_10 = (airtempc / 10),
         airtempc_100 = (airtempc / 100)
         ) %>% 
  pivot_longer(
    cols = c("airtempc", "airtempc_10", "airtempc_100"),
    names_to = "airtemp_type",
    values_to = "airtempC"
  )

#plot 
p_air_30 <- ggplot(data = air_temp_30_clean) + 
  geom_line(aes(x = datetime, y = airtempC, color = airtemp_type)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Air Temperature (ºC)", 
       title = "2017 - 2022 Daily Air Temperatures")

#static plot
p_air_30

#interactive plot
#ggplotly(p_air_30)
```

## Peatland Daily Water Table

-   Read in the data from the following Box file path:
    `External-MEF_DATA/EDI/peatland_water_table_daily/edi.562.2/data_objects/`

-   Clean the data into a tidy format

    -   Subset precipitation data to 2017 - present

-   Plot

```{r bogwell_daily}
#set file path to read in data from Box 
filepath = "/Users/miaforsline/Library/CloudStorage/Box-Box/External-MEF_DATA/EDI/peatland_water_table_daily/edi.562.2/data_objects/"

#read in the raw data 
bogwell <- read_csv(here(filepath, "MEF_daily_peatland_water_table.csv"))

#clean the data
bogwell_clean <- bogwell %>% 
  clean_names() %>% 
  subset(peatland == "S2") %>% 
  mutate(year = format(as.POSIXct(date, format = '%Y-%m-%d', 
                                  tz = "GMT"), 
                       format = '%Y'),
         year = as.numeric(year)) %>% 
  subset(year >= 2017)

#plot
p_bogwell <- ggplot(data = bogwell_clean) + 
  geom_line(aes(x = date, y = wte)) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Water Table Elevation (m above sea level)",
       title = "S2 Daily Peatland Water Table Elevation")

#ggplotly(p_bogwell)
```

# Comparisons

## Streamflow + precipitation (every 15min)

```{r}
#format precipitation data for a smooth joining process
precip_join <- precip_15_clean %>% 
  rename(datetime = timestamp) %>% 
  pivot_wider(
    names_from = "precip_type",
    values_from = "precip_in"
  )

#join streamflow and precipitation data 
streamflow_precip <- full_join(x = all_streamflow, y = precip_join, by = "datetime") %>% 
  rename(precip_10_in = precip_10) %>% 
  select(-precip_in) 

#plot 
p_sp <- ggplot() + 
  #precipitation data 
  geom_line(data = streamflow_precip, 
            aes(x = datetime, 
                y = precip_10_in,
                colour = I("grey")),
            size = 0.25) + 
  #streamflow data 
  geom_line(data = all_streamflow,
             aes(x = datetime, 
                 y = stream_height_ft),
            color = "blue",
            size = 0.25) + 
  theme_classic() + 
  labs(x = "Time", 
       title = "2017 - 2019 S2 Bog Streamflow and Scaled Precipitation",
       subtitle = "Streamflow is plotted in blue. Precipitation is plotted in black.") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, 
                                     size = 7)) + 
  scale_y_continuous(
    # Features of the first axis
    name = "Stream Height (ft)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~.*0.698509267, name = "Precipitation Sum Scaled by 10 (in)")
  ) 

#static plot
#p_sp

#save the plot in the figures folder 
ggsave(filename = "streamflow_and_scaled_precip.png",
       plot = p_sp,
       path = "figures/",
       width = 6,
       height = 3,
       units = c("in"),
       dpi = 300)

ggplotly(p_sp)
```

## Streamflow + air temperature data (every 30min)

```{r}
#format air temperature data 
airtemp_join <- air_temp_30_clean %>% 
  pivot_wider(
    names_from = "airtemp_type",
    values_from = "airtempC"
  ) %>% 
  subset(year >= 2017 & year <= 2019)

#plot 
p_sa <- ggplot() + 
  # #precipitation data 
  # geom_line(data = streamflow_precip, 
  #           aes(x = datetime, 
  #               y = precip_10_in,
  #               colour = I("grey")),
  #           size = 0.25) + 
  #airtemp data
  geom_line(data = airtemp_join, 
            aes(x = datetime, 
                y = airtempc_100),
            color = "pink",
            alpha = 0.5,
            size = 0.25) + 
  #streamflow data 
  geom_line(data = all_streamflow,
             aes(x = datetime, 
                 y = stream_height_ft),
            color = "blue",
            size = 0.25) + 
  theme_classic() + 
  labs(x = "Time", 
       title = "S2 Bog Streamflow and Air Temperature (2017 - 2019)",
       subtitle = "Air temperature is plotted in pink. Streamflow is plotted in blue.") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, 
                                     size = 7)) + 
  scale_y_continuous(
    # Features of the first axis
    name = "Air Temperature / 100 (ºC)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~.*1, name = "Stream Height (ft)")
  ) 

#static plot
#p_sa

#save the plot in the figures folder 
ggsave(filename = "streamflow_airtemp.png",
       plot = p_sa,
       path = "figures/",
       width = 6,
       height = 3,
       units = c("in"),
       dpi = 300)

#interactive plot
ggplotly(p_sa)
```

## Streamflow + bogwell data

```{r}
#sum streamflow by day 
streamflow_daily <- all_streamflow %>% 
  group_by(date) %>% 
  summarise(sum_stream_height_ft = sum(stream_height_ft, na.rm = TRUE))

#combine daily precipitation + daily streamflow sums 
streamflow_precip_daily <- full_join(x = precip_daily_clean,
                                     y = streamflow_daily,
                                     by = "date") %>% 
  pivot_wider(names_from = "precip_type",
              values_from = "precip_in") %>% 
  select(-south_flag,
         -"NA") %>% 
  subset(year <= 2019)

#combine daily precipitation, daily streamflow, and daily bogwell data 
streamflow_precip_bogwell <- full_join(x = streamflow_precip_daily, y = bogwell_clean, by = c("date", "year")) %>% 
  select(-flag,
         -peatland) %>% 
  mutate(wte_100 = (wte / 100)) %>% 
  subset(year <= 2019)


#plot 
p_sb <- ggplot() + 
 # #precipitation data 
 #  geom_line(data = streamflow_precip_bogwell, 
 #            aes(x = date, 
 #                y = precip_10,
 #                colour = I("grey")),
 #            size = 0.25) + 
  #streamflow data 
  geom_line(data = streamflow_precip_bogwell,
             aes(x = date, 
                 y = sum_stream_height_ft),
            color = "blue",
            size = 0.25) + 
  #bogwell data
  geom_line(data = streamflow_precip_bogwell,
            aes(x = date,
                y = wte_100), 
            color = "green",
            size = 0.25) +
  theme_classic() + 
  labs(x = "Time", 
       title = "S2 Bog Streamflow and Daily Peatland Water Table Elevation",
       subtitle = "Streamflow is plotted in blue. Bogwell data is plotted in green") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, 
                                     size = 7)) + 
  scale_y_continuous(
    # Features of the first axis
    name = "Peatland WTE / 100 (m above sea level)",
    # Add a second axis and specify its features
    sec.axis = sec_axis(trans = ~.*1, name = "Stream Height (ft)")
  ) 

#static plot
p_sb

#save the plot in the figures folder 
ggsave(filename = "streamflow_bogwell.png",
       plot = p_sb,
       path = "figures/",
       width = 6,
       height = 3,
       units = c("in"),
       dpi = 300)

#interactive plot 
#ggplotly(p_sb)
```

## Stripchart + old shaft encoder data

```{r}
stripchart_se <- full_join(x = all_streamflow, y = se_clean, by = "datetime")

p_stripchart_se <- ggplot() + 
  geom_line(data = all_streamflow, 
            aes(x = datetime, y = stream_height_ft),
            color = "blue",
            size = 0.25) + 
  geom_line(data = se_clean, 
            aes(x = datetime, y = stage),
            color = "red",
            alpha = 0.75,
            size = 0.25) + 
  theme_classic() + 
  labs(x = "Time", 
       y = "Stream Height (ft)",
       title = "Stripchart vs Shaft Encoder S2 Streamflow (2017 - 2019)",
       subtitle = "Stripchart data is in blue. Shaft encoder data is in red.") + 
  theme(plot.title = element_text(hjust = 0.5),
        plot.subtitle = element_text(hjust = 0.5, 
                                     size = 7))

#static plot
#p_stripchart_se

ggsave(filename = "stripchart_shaft_encoder.png",
       plot = p_stripchart_se,
       path = "figures/",
       width = 6,
       height = 3,
       units = c("in"),
       dpi = 300)

ggplotly(p_stripchart_se)
```
